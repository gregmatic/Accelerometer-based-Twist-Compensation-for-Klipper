[gcode_macro ACCEL_TWIST]
description: Step along an axis for accelerometer measurements in absolute mode with safety checks
gcode:
    ; --- Axis ---
    {% if "AXIS" in params and params.AXIS.strip() %}
        {% set axis = params.AXIS|upper %}
    {% else %}
        {% set axis = "X" %}
    {% endif %}
    {% set stepper = 'stepper_' ~ axis|lower %}

    {% if stepper not in printer.configfile.settings %}
        {action_respond_info("No config section for %s" % stepper)}
        M112
    {% endif %}

    {% set pos_min = printer.configfile.settings[stepper].position_min %}
    {% set pos_max = printer.configfile.settings[stepper].position_max %}

    ; --- Idiot proofing: enforce defaults, clamp values, validate user input ---
    {% if "START" in params and params.START.strip() %}
        {% set start = params.START|float %}
    {% else %}
        {% set start = pos_min + 5 %}
    {% endif %}
    {% if start < pos_min or start >= pos_max %}
        {% set start = pos_min + 5 %}
    {% endif %}

    {% if "END" in params and params.END.strip() %}
        {% set end = params.END|float %}
    {% else %}
        {% set end = pos_max - 5 %}
    {% endif %}
    {% if end > pos_max or end <= start %}
        {% set end = pos_max - 5 %}
    {% endif %}

    {% if "STEP" in params and params.STEP.strip() %}
        {% set step = params.STEP|float %}
    {% else %}
        {% set step = 5 %}
    {% endif %}
    {% if step <= 0 or (start + step) > pos_max %}
        {% set step = 1 %}
    {% endif %}

    {% if "VELOCITY" in params and params.VELOCITY.strip() %}
        {% set v = params.VELOCITY|float %}
    {% else %}
        {% set v = 5 %}
    {% endif %}
    {% if v <= 0 %}
        {% set v = 1 %}
    {% endif %}

    ; --- Go to start (absolute) ---
    G90
    G1 {axis}{start} F{v*60}
    RESPOND MSG="Starting at {axis}={start}, step={step}, velocity={v}"

    ; --- Determine number of steps ---
    {% if end >= start %}
        {% set nsteps = ((end - start) // step) + 1 %}
        {% set direction = 1 %}
    {% else %}
        {% set nsteps = ((start - end) // step) + 1 %}
        {% set direction = -1 %}
    {% endif %}

    ; --- Absolute stepping loop ---
    {% for i in range(nsteps) %}
        {% set pos = start + (i * step * direction) %}
        G4 P1000
        ACCELEROMETER_MEASURE CHIP=lis2dw NAME={pos}
        G4 P1000
        ACCELEROMETER_MEASURE CHIP=lis2dw NAME={pos}

        {% if i < nsteps - 1 %}
            G1 {axis}{pos + step * direction} F{v*60}
            RESPOND MSG="Step {i+1} â†’ {axis}={pos + step * direction}"
        {% endif %}
    {% endfor %}

    ; --- Finish ---
    G90
    RESPOND MSG="ACCEL_TWIST complete (samples: {nsteps})"
